# ZenBreath 测试文档

## 1. 测试目标

- 用自动化覆盖关键路径，尽量减少人工反复点测。
- 优先保障三件事：不会崩、声音不断、节奏不乱。
- 形成“改完即验”的固定流程，避免回归遗漏。

## 2. 测试策略（分层）

### L0 静态检查（每次提交）

- HTML/CSS/JS 基础语法检查。
- 禁止明显高风险写法（未捕获异常、死循环递归入口）。

### L1 流程冒烟（自动化）

- 自动打开页面、进入会话、切换关键配置、结束会话。
- 控制台出现 `error` 或关键告警直接失败。

### L2 音频健康检查（自动化）

- 切换 `地/水/火/风/空` 时检测音频链路是否持续产出信号。
- 检测 `AudioContext` 状态、`GainNode` 有效值、无 `NaN/Infinity`。
- 捕获 `BiquadFilterNode ... bad state` 立即失败。

### L3 稳定性检查（自动化，定时或 nightly）

- 连续运行 10 分钟。
- 周期切换环境音和呼吸模式。
- 统计错误次数、音频断流次数、UI 停滞次数。

### L4 最小人工回归（发布前）

- 只保留自动化无法可靠替代的感官验收项（见第 6 节）。

## 3. 自动化技术方案

- 框架：Playwright（Edge/Chromium）。
- 执行方式：本地与 CI 同一套脚本。
- 核心手段：
- 页面操作自动化（点击按钮、改输入值、读文本）。
- 控制台监听（收集 `error/warn`）。
- 页面内探针（测试模式读取关键运行状态）。

系统已提供只读对象 `window.__qa__`：

- `session`: `isSessionActive`, `currentPhase`, `remainingSessionTime`
- `audio`: `audioCtxState`, `ambientType`, `ambientGainValue`, `lastAudioError`
- `timers`: 当前阶段倒计时、全局倒计时
- `insights`: `sessionsToday`, `totalMinutesToday`
- `saved`: `hasLastSettings`

这样自动化可以“看见内部状态”，不需要靠猜 UI。

## 4. 关键测试用例


| ID     | 级别  | 自动化 | 用例描述                                   | 通过标准                       |
| ------ | --- | --- | -------------------------------------- | -------------------------- |
| TC-001 | P0  | 是   | 页面加载后可见设置面板和开始按钮                       | 无未捕获错误；关键元素存在              |
| TC-002 | P0  | 是   | 默认配置启动会话                               | 进入运行态；状态文本变化；全局计时显示        |
| TC-003 | P0  | 是   | 会话中切换 `地/水/火/风/空`                      | 不报错；音频上下文保持 `running`      |
| TC-004 | P0  | 是   | 会话中环境音开关和音量滑条联动                        | 打开时增益>0；关闭时增益趋近 0          |
| TC-005 | P0  | 是   | 四段时长包含 0 秒时流程连续推进                      | 不死循环；相位可继续流转               |
| TC-006 | P0  | 是   | 固定时长模式自动结束                             | 到时调用结束态；文本恢复初始引导           |
| TC-007 | P1  | 是   | 无尽模式持续 3 分钟                            | 不自动结束；全局文本为“深 空 无 尽”       |
| TC-008 | P1  | 是   | 切换呼吸模式（4-4-4-4 / 4-7-8 / 5-5 / custom） | 状态机节奏符合配置                  |
| TC-009 | P1  | 是   | 设置面板开关与遮罩点击关闭                          | 交互一致；无卡死                   |
| TC-010 | P0  | 是   | 连续切换环境音 30 次压力测试                       | 无 `Biquad bad state`；无静音锁死 |
| TC-011 | P1  | 是   | 提示音触发（吸/呼/屏息）                          | 每阶段有可检测瞬态能量                |
| TC-012 | P2  | 是   | 背景图加载失败降级                              | 回退到渐变背景，不影响会话              |
| TC-013 | P2  | 是   | 窗口 resize 后粒子与布局                       | 不错位、不抛错                    |
| TC-014 | P0  | 是   | `__qa__` 暴露会话与音频健康字段                 | 会话、音频字段存在且与运行状态一致         |
| TC-015 | P0  | 是   | `__qa__` 反映环境音类型与增益变化                | 切换和开关后 `ambientType/gain` 正确变化 |
| TC-016 | P1  | 是   | `__qa__` 计时字段在无尽模式可读取                 | `phaseCountdown/globalText` 有效       |
| TC-017 | P0  | 是   | 上次设置持久化与继续按钮可用                       | 刷新后可恢复配置，继续按钮可点击        |
| TC-018 | P0  | 是   | 今日练习统计在会话结束后累加                       | `sessions/minutes` 增长且 UI 更新       |
| TC-019 | P1  | 是   | 移动端设置面板与继续按钮显示可用                    | `390x844` 下无溢出，可交互              |


## 5. 一键验证流程（建议）

1. `smoke`：30-60 秒，验证主流程可用。
2. `audio`：1-2 分钟，验证音频链路健康。
3. `stability`：10 分钟，验证长时稳定性。
4. 汇总报告：失败截图 + 控制台日志 + 触发步骤。

仅当 `smoke + audio` 全绿，才允许继续开发合并；`stability` 可按日跑。

线上补充：

- 线上 smoke 自动化用例：`tests/online-smoke.spec.js`
- CI 工作流：`.github/workflows/online-smoke.yml`
- 触发方式：Vercel 部署成功自动触发，或 GitHub Actions 手动输入 URL 触发
- 如果本地外网受限，先设置代理（示例：`http://127.0.0.1:7897`）再执行 `npm run test:online-smoke`

命令约定：

- 本地回归：`npm run test:e2e`
- 本地 + 线上用例全跑：`npm run test:e2e:all`
- 线上 smoke：`npm run test:online-smoke`

## 6. 最小必要人工测试范围

自动化通过后，仅保留以下人工检查：

- MT-01 主观听感：五种环境音风格差异是否符合预期（不是“有没有声”，而是“像不像”）。
- MT-02 主观舒适度：提示音是否刺耳，音量默认值是否舒适。
- MT-03 跨设备听感：至少 1 次耳机 + 1 次外放抽查。

除以上 3 项外，其它全部自动化覆盖，不再重复人工点测。

## 7. 退出标准（Release Gate）

- P0 用例通过率 100%。
- P1 用例通过率 >= 95%，且无阻断缺陷。
- 无 `Biquad bad state`、无未捕获异常、无会话中断死锁。
- 人工最小回归 3 项全部通过。

## 8. 后续增强建议

1. 增加音频波形快照存档，用于版本间对比（回归“变味”）。
2. 建立缺陷分级与 SLA（P0 当天修复，P1 本周修复）。
3. 生成趋势报表（近 7 天失败率、最常见失败用例）。
